.SUBDIRS: lib compat

PROJ = sdmsh

## Path to the AR program
AR ?= ar

## Path to the C Compiler
CC ?= cc

## Default C Compiler Flags
CFLAGS ?= -std=gnu99 -O2 -Wall -Wextra

## Default C Preprocessor Flags
CPPFLAGS ?= -D_GNU_SOURCE -D_BSD_SOURCE -DLOGGER_ENABLED
CPPFLAGS += -I$. -I$./lib/libsdm -I$./lib/libstream

## Default Linker Flags
LDFLAGS ?=

## Installation prefix
PREFIX ?= /usr/local

# export the current value of these variables into subdirectories
.EXPORTS: AR CC CFLAGS CPPFLAGS LDFLAGS PREFIX

## Enable compatibility with readline version 6
COMPAT_READLINE6 ?= 0

## Compile ${PROJ} statically
BUILD_STATIC_BIN ?= 0

# Comment this if you do not want checking with address sanitize
# NOTE: you can use shell variable ASAN_OPTIONS=fast_unwind_on_malloc=false before run sdmsh
# also read https://github.com/google/sanitizers/wiki/AddressSanitizerFlags#run-time-flags
## Build ${PROJ} with address sanitizers enabled
WITH_ADDRESS_SANITIZE ?= 0

SRC = sdmsh.c sdmsh_commands.c shell.c shell_history.c shell_completion.c shell_help.c
OBJ = ${SRC:.c=.o}
OS != uname

.if "${BUILD_STATIC_BIN}"
STATIC = --static
.endif

.if "${OS}" == "OpenBSD"
XRLINC = -I/usr/local/include/ereadline -DHAVE_STRING_H
XRLLIB = -L/usr/local/lib -lereadline
.else
XRLINC != pkg-config --cflags readline
XRLLIB != pkg-config --libs ${STATIC} readline
.endif

## CFLAGS for readline
RLINC ?= ${XRLINC}

## LDFLAGS for readline
RLLIB ?= ${XRLLIB}

CFLAGS += -ggdb -fPIC ${RLINC}

.if "${WITH_ADDRESS_SANITIZE}" && "${OS}" != "OpenBSD"
CFLAGS	+= -fsanitize=address
LDFLAGS	+= -fsanitize=address
.endif

.if "${COMPAT_READLINE6}" == "1"
OBJ	+= compat/readline6.o
CFLAGS	+= -DCOMPAT_READLINE6
.endif

LDFLAGS += -lncurses ${RLLIB}
LDFLAGS += -L${.OBJDIR}/lib/libsdm -lsdm
LDFLAGS += -L${.OBJDIR}/lib/libstream -lstream
LDFLAGS += -lm

.if "${BUILD_STATIC_BIN}"
LDFLAGS += -static
.endif

# Rules

## Build sdmsh
all: ${PROJ} sampleconv

## Delete all build artifacts
clean: lib/clean compat/clean
	rm -f ${.OBJDIR}/${PROJ} ${.OBJDIR}/sampleconv ${.OBJDIR}/*.o ${.OBJDIR}/*.so

## Install sdmsh and shared libraries
install: sdmsh lib/install
	mkdir -p ${DESTDIR}${PREFIX}/bin
	cp -f $< ${DESTDIR}${PREFIX}/bin/

## Delete even more things
distclean: clean
	rm -f cscope.out tags make/mk

sdmsh: ${OBJ} lib/libsdm/libsdm.a lib/libstream/libstream.a
	${CC} -o $@ ${OBJ:F} ${CFLAGS} ${CPPFLAGS} ${LDFLAGS}

sampleconv: sampleconv.c
	${CC} -o $@ $< ${CFLAGS} ${CPPFLAGS}

.c.o:
	${CC} -c -o $@ $< ${CFLAGS} ${CPPFLAGS}

# Template for library dependencies
.template lib
OBJ = ${SRC:.c=.o}

## Build both the static and shared library for ${PROJ}
all: ${PROJ}.a ${PROJ}.so

## Remove all build artifacts for ${PROJ}
clean:
	rm -f ${.OBJDIR}/${PROJ}.a ${.OBJDIR}/${PROJ}.so ${.OBJDIR}/*.o

.if target(clean-extra)
clean: clean-extra
.endif

## Install ${PROJ}.so into ${DESTDIR}${PREFIX}/lib/
install: ${PROJ}.so
	mkdir -p ${DESTDIR}${PREFIX}/lib
	cp -f ${.OBJDIR}/${PROJ}.so ${DESTDIR}${PREFIX}/lib/

## Build ${PROJ}'s static library
${PROJ}.a: ${OBJ}
	${AR} rcs $@ ${OBJ:F}

## Build ${PROJ}'s shared library
${PROJ}.so: ${OBJ}
	${CC} -shared -o $@ ${OBJ:F} ${CFLAGS}
.endt

